
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>Deploying PostgreSQL to Azure with Bicep</title>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/dist/reset.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/dist/reveal.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/dist/theme/simple.css" id="theme">
    <link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/a11y-light.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono|Roboto:300,400,500|Work+Sans:400,700">
        <style>
			.reveal {
				font-family: "Work Sans", sans-serif;
			}

			.reveal .slides section {
				text-align: left;
				font-size: smaller;
			}

      .slide-number-a {
          background-color: #747474;
      }

      .reveal section li {
          margin-bottom: 12px;
      }

			.reveal pre {
				width: 100%;
				border-left: 2px solid #ccc;
        border-right: 2px solid #ccc;
				box-shadow: none;
        font-size: 24px;
			}

      .reveal pre code {
        padding: 0px 8px 0px 8px;
      }

      .reveal .code-badge {
        right: 10px;
      }

      .reveal code {
          font-family: "Roboto Mono", monospace;
      }

			.reveal h1, .reveal h2, .reveal h3, .reveal h4, .reveal h5, .reveal h6 {
				font-family: "Roboto", sans-serif;
				color: #0072c1;
			}

			.reveal section.heading-only {
				text-align:center;
				padding-top:10%;
			}

      .no-code-badge .code-badge {
          display: none;
      }

      .code-badge-language {
          display: none;
      }

			.reveal h3 {
				margin-bottom: 40px;
			}

            .smaller {
                font-size: smaller;
            }

            code {
                padding: 2px 4px;
                font-size: 90%;
                color: #0072c1;
                background-color: #f9f2f4;
                border-radius: 4px;
            }

            p.padded {
                margin-top: 32px;
            }

            section .row {
                display: flex;
            }

            section .column {
                flex: 48%;
                margin: 10px;
            }

			@media print
			{
				.no-print, .no-print *, .code-badge
				{
					display: none !important;
				}
			}

      .aka {
        font-family: "Roboto Mono", monospace;
        background-color: #1c6192;
        color: white;
        padding: 8px;
        border-radius: 6px;
        display: inline-block;
      }
		</style>
	</head>
    <body>
    <div class="reveal">
        <div class="slides">

            <section class="heading-only" style="padding-top:5%">
                <h1 style="font-size:2.5em;">Deploying PostgreSQL to Azure with Bicep
                </h1>

                <img src="../media/BIT_AZURE.png" alt="Raccoon in the clouds" height="300">

                <div class="no-print" style="text-align: left; margin-top: 100px; font-size: 70%; display:none;">
                    Tips for navigating the slides:
                    <ul>
                        <li>Press O or Escape for overview mode.</li>
                        <li>Visit <a href="?print-pdf" target="_blank">this link</a> for a nice printable version</li>
                        <li>Press the copy icon on the upper right of code blocks to copy the code</li>
                    </ul>
                </div>

            </section>

            <section>
                <h3>About me</h3>

                <img src="pamela_elephant.png" alt="Photo of Pamela smiling with a stuffed elephant" style="width: 350px; float:right; border-radius: 12px;">

                <p>Python Cloud Advocate at Microsoft</p>
                <p>Formerly: UC Berkeley, Coursera, Khan Academy, Google</p>
                <br>
                <p>Find me online at:</p>
                <table style="width:40%; float: left; font-size:28px;">
                    <tr>
                      <td>Mastodon
                      <td><a target="_blank" href="https://fosstodon.org/@pamelafox">@pamelafox@fosstodon.org</a></td>
                    </tr>
                    <tr>
                        <td>Twitter
                        <td><a target="_blank" href="https://twitter.com/pamelafox">@pamelafox</a></td>
                      </tr>
                    <tr>
                        <td>GitHub
                        <td><a target="_blank" href="https://www.github.com/pamelafox">www.github.com/pamelafox</a></td>
                      </tr>
                    <tr>
                        <td>Website
                        <td><a target="_blank" href="https://www.pamelafox.org">pamelafox.org</a></td>
                      </tr>
                  </table>
            </section>

            <section>
                <h3>Managed services for PostgreSQL on Azure</h3>

                <style>
                .fragment.background-green {
                    background-color: transparent;
                }
                .fragment.background-green.visible {
                    background-color: aquamarine;
                }
                </style>

                <table>
                    <thead>
                        <tr>
                            <th>Option</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Azure Database for PostgreSQL – Single Server</td>
                            <td>Microsoft's original offering. No longer recommended for new apps.</td>
                        </tr>
                        <tr class="fragment custom background-green">
                            <td>Azure Database for PostgreSQL – Flexible Server</td>
                            <td>Microsoft's most recent PostgreSQL offering. Fully managed service with vertical scaling.
                            </td>
                        </tr>
                        <tr>
                          <td>Azure Cosmos DB for PostgreSQL</td>
                          <td>Distributed database using PostgreSQL and the Citus extension. Can scale horizontally.
                          </td>
                      </tr>
                    </tbody>
                </table>

                <p class="smaller">
                    <a target="_blank" href="https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-compare-single-server-flexible-server">
                      <span class="aka"> 🔗 aka.ms/flex-vs-single</span>
                      Comparison: Flexible vs. Single Server </a>
                   <br>
                   <a target="_blank" href="https://devblogs.microsoft.com/cosmosdb/azure-cosmos-db-for-postgresql-vs-azure-database-for-postgresql-when-to-choose-which/">
                    <span class="aka" style="margin-top: 16px;"> 🔗 aka.ms/flex-vs-cosmos</span>
                    Cosmos DB for PostgreSQL vs. Flex Server </a>
                </p>
            </section>

            <section class="heading-only">
                <h2>Ways to deploy<br> a PostgreSQL Flexible Server</h2>

                <img src="../media/BIT_COWORKING.png" alt="Three raccoons with laptops" height="300">
            </section>

            <section>
                <h3>Using the Azure Portal</h3>

                <img src="screenshot_azureportal.png" alt="Azure portal screenshot" style="border:1px solid #ddd"/>
    
                <p class="fragment">😃 Easy to get started 😭 but difficult to replicate.</p>
                <!-- 
                <p>Similar experience: VS Code extension.</p> 
                az deployment group create --resource-group cituscon-examples-eastus --template-file postgres-bicep/vnet.bicep
                -->
            </section>

            <section>
                <h3>Using CLI commands</h3>
    
                <table>
                    <thead style="display:none;">
                        <tr>
                        <th>Method</th>
                        <th>Example</th>
                        </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>Azure CLI</td>
                        <td>
                            <pre><code data-trim data-noescape class="shell">
                        az postgres flexible-server create --resource-group pg-grp \
                            --name pg-srv --location westus \
                            --sku-name GP_Gen5_2 --version 14 \
                            --admin-user myadmin --admin-password NeverShowThis
                            </code></pre>
                        </td>
                      </tr>
                      <tr>
                        <td>Azure PowerShell</td>
                        <td>
                            <pre><code data-trim data-noescape class="shell">
                        New-AzPostgreSqlFlexibleServer -ResourceGroupName pg-grp \
                            -ServerName pg-srv -Location westus \
                            -SkuName GP_Gen5_2 -Version 14 \
                            -AdministratorLogin myadmin -AdministratorLoginPassword NeverShowThis
                            </code></pre>
                        </td>
                      </tr>
                    </tbody>
                  </table>

                  <p class="fragment">😃 Replication is now possible!<br>
                    😭 Updating resource parameters requires different commands than creation.
                  </p>
            </section>

            <section>
                <h3>Using ARM templates</h3>
                
                <p><strong>ARM (Azure Resource Manager)</strong> templates are JSON files that describe
                    the resources you want to create.
                </p>

                <pre style="height: 260px; overflow-y: scroll;"><code data-trim data-noescape class="shell">
                {
                    "type": "Microsoft.DBforPostgreSQL/flexibleServers",
                    "apiVersion": "2021-06-01",
                    "name": "pg-srv",
                    "location": "westus",
                    "sku": {
                      "name": "Standard_B1ms",
                      "tier": "Burstable"
                    },
                    "properties": {
                        "administratorLogin": "admin-user",
                        "administratorLoginPassword": "NeverShowThis",
                        "version": "14"
                    }
                  ...
                </code></pre>
                <p>👁️ See full example in <code>postgres_database.bicep</code></p>

                <p class="fragment">😃 Repeatable provisioning of all resource types<br>
                    😭 JSON files can be unwieldy and hard to parameterize
                </p>
            </section>

            <section class="heading-only">
                <h2>Bicep</h2>

                <img src="../media/DATA_BIT.png" alt="Bit the raccoon, dressed as Neo from Matrix" height="300"/>
            </section>
            

            <section>
                <h3>Using Bicep</h3>

                <p><strong>Bicep</strong> is a DSL (domain-specific language) that compiles to ARM templates.</p>

                <pre style="height:475px;"><code data-trim data-noescape class="bicep">
                    resource server 'Microsoft.DBforPostgreSQL/flexibleServers@2021-06-01' = {
                        name: 'pg-srv'
                        location: 'eastus'
                        sku: {
                          name: 'Standard_B1ms'
                          tier: 'Burstable'
                        }
                        properties: {
                          administratorLogin: 'myadmin'
                          administratorLoginPassword: 'NeverShowThis'
                          version: '14'
                          storage: {
                            storageSizeGB: 128
                          }
                        }
                      }                      
                </code></pre>
            </section>

            <section>
                <h3>The Bicep language</h3>

                <table style="margin:0">
                    <thead>
                      <tr>
                        <th>Feature</th>
                        <th>Example</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td style="width:270px;">Parameters</td>
                        <td><pre style="font-size: 26px; margin:0; width: 800px;" class="no-code-badge"><code class="bicep">param location string = 'eastus'</code></pre></td>
                      </tr>
                      <tr>
                        <td>Types</td>
                        <td><pre style="font-size: 26px; margin:0" class="no-code-badge"><code class="bicep">param storageSizeGB int = 128</code></pre></td>
                      </tr>
                      <tr>
                        <td>Logic</td>
                        <td><pre style="font-size: 26px; margin:0" class="no-code-badge"><code class="bicep">skuTier == 'Burstable' ? 32 : 128</code></pre></td>
                      </tr>
                      <tr>
                        <td>Loops</td>
                        <td><pre style="font-size: 26px; margin:0" class="no-code-badge"><code class="bicep">for i in range(0, serverCount):</code></pre></td>
                      </tr>
                      <tr>
                        <td>Functions</td>
                        <td><pre style="font-size: 26px; margin:0" class="no-code-badge"><code class="bicep">param adminUsername string = newGuid()    </code></pre></td>
                      </tr>
                      <tr>
                        <td>Modules</td>
                        <td><pre style="font-size: 26px; margin:0" class="no-code-badge"><code class="bicep">module myServer 'flexserver.bicep' { }   </code></pre></td>
                      </tr>
                    </tbody>
                  </table>

                  <p class="smaller">
                    <a target="_blank" href="https://docs.microsoft.com/azure/azure-resource-manager/bicep/file">
                      <span class="aka"> 🔗 aka.ms/bicep-syntax</span>
                      Bicep file structure & syntax
                  </a></p>
            </section>

            <section>
                <h3>A parameterized Bicep file</h3>

                <p>Use <strong>parameters</strong> for values that vary across deployments.</p>
                <pre style="font-size: 22px; height:520px;"><code data-trim data-noescape class="bicep">
                    param serverName string = 'pg-srv'
                    param location string = 'eastus'
                    @secure()
                    param adminPassword string

                    resource srv 'Microsoft.DBforPostgreSQL/flexibleServers@2021-06-01' = {
                        name: serverName
                        location: location
                        sku: {
                          name: 'Standard_B1ms'
                          tier: 'Burstable'
                        }
                        properties: {
                          administratorLogin: 'myadmin'
                          administratorLoginPassword: adminPassword
                          version: '14'
                          storage: { storageSizeGB: 128 }
                        }  
                    }
                </code></pre>

            </section>
                
            <section>
                <h3>Deploying from Bicep</h3>

                <p>Use <code>az deployment group create</code> to create or update resources in an existing resource group:</p>
                <pre style="white-space: pre-wrap;" class="no-code-badge"><code data-trim data-noescape data-line-numbers="1|2|3-11" class="shell">
                $ az deployment group create --resource-group pg-grp --template-file pg.bicep
                Please provide securestring value for 'adminPassword' (? for help):
                {
                    "name": "postgres_example1",
                    "properties": {
                        "outputResources": [{
                            "id": "/subscriptions/32ea8a26-5b40-4838-b6cb-be5c89a57c16/resourceGroups/cituscon-examples-eastus/providers/Microsoft.DBforPostgreSQL/flexibleServers/pg-srv",
                            "resourceGroup": "pg-grp"
                          }],
                    ...
                }
                </code></pre>

                <div class="fragment">
                <p>Optionally, specify parameters on the command line:</p>
                <pre><code data-trim data-noescape class="shell">
                $ az deployment group create --resource-group pg-grp --template-file pg.bicep \
                   --parameters adminPassword=ADMIN_PASSWORD
                </code></pre>
                </div>
            </section>

            <section>
                <h3>Deploying from Bicep (Result)</h3>

                <p style="margin-bottom: 0px;">The server will be available in the Azure Portal:</p>
                <img src="screenshot_azureportal_pg.png" alt="Screenshot of Portal overview page for server" style="border: 1px solid #ccc; height: 500px;">
            </section>

            <section>
                <h3>Child resources</h3>

                <p>A <a target="_blank" href="https://learn.microsoft.com/en-us/azure/azure-resource-manager/bicep/child-resource-name-type">
                    <strong>child resource</strong></a>
                   exists solely within the scope of its parent resource.</p>

                <p>Child resources that can be created for PostgreSQL:</p>
                <ul>
                    <li><code>administrators</code></li>
                    <li><code>configurations</code></li>
                    <li><code>databases</code></li>
                    <li><code>firewallRules</code></li>
                    <li><code>migrations</code></li>
                </ul>

                <p class="smaller">+ Read-only child resources: <code>advisors</code>, <code>backups</code>, <code>queryTexts</code>.
                </p>
            </section>

            <section>
                <h3>Child resources: database</h3>
                
                <p>The server will always include a database called <code>postgres</code>
                    plus system databases <code>azure_maintenance</code>, <code>azure_sys</code>.</p>

                <p>Create an additional database:</p>
                <pre><code data-trim data-noescape class="bicep">
                resource postgresServer 'Microsoft.DBforPostgreSQL/flexibleServers@2022-12-01' = {
                    name: serverName
                    location: location
                    ...

                    resource database 'databases' = {
                        name: 'webapp'
                    }
                }
                </code></pre>

                <p class="smaller">👁️ See full example in <a target="_blank" href="postgres_database.bicep"><code>postgres_database.bicep</code></a></p>

            </section>

            <section>
                <h3>Child resources: databases</h3>
                
                <p>Create multiple databases with an <code>array</code> and <code>for</code> loop:</p>

                <pre><code data-trim data-noescape class="bicep">
                param databaseNames array = ['webapp', 'analytics']

                resource postgresServer 'Microsoft.DBforPostgreSQL/flexibleServers@2022-12-01' = {
                    name: serverName
                    location: location
                    ...

                    resource database 'databases' = [for name in databaseNames: {
                        name: name
                    }]
                }
                </code></pre>

                <p class="smaller">👁️ See full example in <a target="_blank" href="postgres_database.bicep"><code>postgres_databases.bicep</code></a></p>
            </section>


            <section>
                <h3>Child resources: databases (Result)</h3>

                <p style="margin-bottom: 0px;">The databases will be listed in the Azure Portal:</p>
                <img src="screenshot_azureportal_dbs.png" alt="Screenshot of Databases page of PostgreSQL server" style="border: 1px solid #ccc; height: 500px;">
            </section>

            <section>
                <h3>Child resources: firewall rule</h3>

                <p>By default, the server is not accessible from any IP ranges.
                   You can use <code>firewallRules</code> to allow access from IPs.
                </p>

                <p>Allow access from any Azure service within Azure:</p>

                <pre><code data-trim data-noescape class="bicep">
                resource firewallAzure 'firewallRules' = {
                    name: 'allow-all-azure-internal-IPs'
                    properties: {
                        startIpAddress: '0.0.0.0'
                        endIpAddress: '0.0.0.0'
                    }
                }
                </code></pre>
                <p>⚠️ Any Azure dev can now access, if they know user/pass.</p>

                <p class="smaller">👁️ See full example in <a target="_blank" href="postgres_azurefirewall.bicep"><code>postgres_azurefirewall.bicep</code></a></p>

            </section>

            <section data-visibility="hidden">
                <h3>Conditional child resources: firewall rule</h3>

                <p>Conditionally create a rule using <code>if</code> with a <code>bool</code> param:</p>

                <pre><code data-trim data-noescape class="bicep">
                param allowAllIPsFirewall bool

                resource postgresServer 'Microsoft.DBforPostgreSQL/flexibleServers@2022-12-01' = {
                    ...
                    resource firewallAll 'firewallRules' = if (allowAllIPsFirewall) {
                        name: 'allow-all-IPs'
                        properties: {
                            startIpAddress: '0.0.0.0'
                            endIpAddress: '255.255.255.255'
                        }
                    }
                }
                </code></pre>
                <p>⚠️⚠️ Anyone at all can access, if they know user/pass.</p>

                <p>👁️ See full example in <code>postgres_condfirewall.bicep</code></p>
            </section>

            <section>
                <h3>Child resources: firewall rules</h3>

                <p>Create rules for each IP in list using <code>array</code> with <code>for</code>:</p>

                <pre><code data-trim data-noescape class="bicep">
                param allowedSingleIPs array = ['103.64.88.254', '44.143.22.28']
    
                resource postgresServer 'Microsoft.DBforPostgreSQL/flexibleServers@2022-12-01' = {
                    ...
    
                    resource firewallSingle 'firewallRules' = [for ip in allowedSingleIPs: {
                        name: 'allow-single-${replace(ip, '.', '')}'
                        properties: {
                            startIpAddress: ip
                            endIpAddress: ip
                        }
                    }]
                }
                </code></pre>
                <p class="smaller">👁️ See full example in <a target="_blank" href="postgres_loopfirewall.bicep"><code>postgres_loopfirewall.bicep</code></a></p>
            </section>

            <section>
                <h3>Child resources: firewall rules (Result)</h3>

                <p style="margin-bottom: 0px;">The firewall rules will be listed in the Azure Portal:</p>
                <img src="screenshot_azureportal_firewalls.png" alt="Screenshot of Networking page of PostgreSQL server" style="border: 1px solid #ccc; height: 500px;">
            </section>

            <section class="heading-only">
                <h2>Using a Virtual Network</h2>
            </section>

            <section>
                <h3>Securing in a VNet</h3>

                <p>As a security best practice, Azure recommends that
                    deploying PostgreSQL servers in a <strong>Virtual Network (VNet)</strong>,
                    along with other Azure resources that need access to it.
                </p>
                <img src="postgres_vnet.png" style="float:right; width:50%">
                <p>That requires multiple resources:</p>
                <ul style="width:40%">
                    <li>Virtual Network
                    <li>Private DNS Zone
                    <li>Whatever resource needs access to the server
                </ul>
            </section>

            <section>
                <h3>Virtual Network</h3>

                <p>Create a VNet with a private address space of 10.0.0.0 - 10.0.255.255:
                <pre><code data-trim data-noescape class="bicep">
                resource virtualNetwork 'Microsoft.Network/virtualNetworks@2019-11-01' = {
                    name: '${name}-vnet'
                    location: location
                    properties: {
                      addressSpace: {
                        addressPrefixes: [
                          '10.0.0.0/16'
                        ]
                      }
                    }
                }
                </code></pre>


            </section>

            <section>
                <h3>Virtual Network: subnets</h3>

                <p>Create subnet with address space of <code>10.0.0.1</code> - <code>10.0.0.255</code>
                    and delegate to PostgreSQL servers:</p>

                <pre><code data-trim data-noescape class="bicep">
                    resource databaseSubnet 'subnets' = {
                        name: 'database-subnet'
                        properties: {
                          <strong>addressPrefix: '10.0.0.0/24'</strong>
                          delegations: [
                            {
                              name: '${name}-subnet-delegation'
                              properties: {
                                serviceName: 'Microsoft.DBforPostgreSQL/flexibleServers'
                              }
                            }]
                        }
                      }
                </code></pre>

                <p class="smaller">
                    <a target="_blank" href="https://techcommunity.microsoft.com/t5/itops-talk-blog/configuring-azure-virtual-network-subnets-with-cidr-notation/ba-p/2047809">
                      <span class="aka"> 🔗 aka.ms/vnet-cidr</span>
                      Configuring Azure VNet subnets with CIDR notation
                    </a>
                </p>
            </section>

            <section>
                <h3>Virtual Network: subnets</h3>

                <p>Create subnet with address space of <code>10.0.1.1</code> - <code>10.0.1.255</code>
                    and delegate to other resource (App Service):</p>
                <pre><code data-trim data-noescape class="bicep">
                resource webappSubnet 'subnets' = {
                    name: 'webapp-subnet'
                    properties: {
                        <strong>addressPrefix: '10.0.1.0/24'</strong>
                        delegations: [
                        {
                            name: '${name}-subnet-delegation-web'
                            properties: {
                            serviceName: 'Microsoft.Web/serverFarms'
                            }
                        }]
                    }
                }
                </code></pre>

                <p class="smaller">
                  <a target="_blank" href="https://techcommunity.microsoft.com/t5/itops-talk-blog/configuring-azure-virtual-network-subnets-with-cidr-notation/ba-p/2047809">
                    <span class="aka"> 🔗 aka.ms/vnet-cidr</span>
                    Configuring Azure VNet subnets with CIDR notation
                  </a>
                </p>
            </section>

            <section>
                <h3>Private DNS Zone</h3>

                <p>To let other service access the PostgreSQL server,
                    create a private DNS Zone:
                </p>

                <pre><code data-trim data-noescape class="bicep">
                resource privateDnsZone 'Microsoft.Network/privateDnsZones@2020-06-01' = {
                    <strong>name: '${pgServerPrefix}.private.postgres.database.azure.com'</strong>
                    location: 'global'
                    resource vNetLink 'virtualNetworkLinks' = {
                        name: '${pgServerPrefix}-link'
                        location: 'global'
                        properties: {
                          registrationEnabled: false
                          virtualNetwork: { id: virtualNetwork.id }
                        }
                    }
                }
                </code></pre>

                <p class="smaller">
                  <a target="_blank" href="https://learn.microsoft.com/azure/dns/private-dns-overview">
                    <span class="aka"> 🔗 aka.ms/private-dns</span>
                    What is Azure Private DNS?
                  </a>
                  <br>
                  <a target="_blank" href="https://learn.microsoft.com/azure/postgresql/flexible-server/concepts-networking#private-dns-zone-and-virtual-network-peering">
                    <span class="aka" style="margin-top: 16px;"> 🔗 aka.ms/pg-vnet-dns</span>
                    PostgreSQL networking: Private DNS Zone and VNets
                  </a>
                </p>
            </section>

            <section>
                <h3>Configure the PostgreSQL server</h3>

                <p>Add the <code>network</code> property on the PostgreSQL server to inject it into the VNet and 
                    connect it to the DNS Zone:</p>
                <pre><code data-trim data-noescape class="bicep">
                resource postgresServer 'Microsoft.DBforPostgreSQL/flexibleServers@2022-01-20-preview' = {
                    name: pgServerPrefix
                    ...

                    properties: {
                        ...
                        network: {
                            <strong>delegatedSubnetResourceId: virtualNetwork::databaseSubnet.id</strong>
                            <strong>privateDnsZoneArmResourceId: privateDnsZone.id</strong>
                        }
                    }
                }
                </code></pre>
            </section>

            <section>
                <h3>Configure the Web App</h3>

                <p>Add a <code>networkConfig</code> child resource on the Web App Service to inject it into the VNet:</p>
                <pre><code data-trim data-noescape class="bicep">
                resource web 'Microsoft.Web/sites@2022-03-01' = {
                    name: '${name}-app-service'
                    ...

                    resource webappVnetConfig 'networkConfig' = {
                        name: 'virtualNetwork'
                        properties: {
                          <strong>subnetResourceId: virtualNetwork::webappSubnet.id</strong>
                        }
                    }
                }
                </code></pre>
            </section>
            
            <section>
                <h3>All together: PostgreSQL in VNet</h3>

                <!-- screenshot of portal resources -->
                <!-- diagram of interaction like https://learn.microsoft.com/en-us/azure/dns/private-dns-overview ? -->
                <pre style="height:400px; overflow-y:scroll"><code data-trim data-noescape class="bicep">
                    param name string = 'pgvnet4'
                    param location string = 'eastus'
                    @secure()
                    param adminPassword string
                    
                    var pgServerPrefix = '${name}-postgres-server'
                    
                    resource virtualNetwork 'Microsoft.Network/virtualNetworks@2019-11-01' = {
                      name: '${name}-vnet'
                      location: location
                      properties: {
                        addressSpace: {
                          addressPrefixes: [
                            '10.0.0.0/16'
                          ]
                        }
                      }
                    
                      resource databaseSubnet 'subnets' = {
                        name: 'database-subnet'
                        properties: {
                          addressPrefix: '10.0.0.0/24'
                          delegations: [
                            {
                              name: '${name}-subnet-delegation'
                              properties: {
                                serviceName: 'Microsoft.DBforPostgreSQL/flexibleServers'
                              }
                            }
                          ]
                        }
                      }
                    
                      resource webappSubnet 'subnets' = {
                        name: 'webapp-subnet'
                        properties: {
                          addressPrefix: '10.0.1.0/24'
                          delegations: [
                            {
                              name: '${name}-subnet-delegation-web'
                              properties: {
                                serviceName: 'Microsoft.Web/serverFarms'
                              }
                            }
                          ]
                        }
                      }
                    }
                    
                    resource privateDnsZone 'Microsoft.Network/privateDnsZones@2020-06-01' = {
                      name: '${pgServerPrefix}.private.postgres.database.azure.com'
                      location: 'global'
                    
                      resource vnetLink 'virtualNetworkLinks' = {
                        name: '${pgServerPrefix}-link'
                        location: 'global'
                        properties: {
                          registrationEnabled: false
                          virtualNetwork: {
                            id: virtualNetwork.id
                          }
                        }
                      }
                    }
                    
                    resource web 'Microsoft.Web/sites@2022-03-01' = {
                      name: '${name}-app-service'
                      location: location
                      kind: 'app,linux'
                      properties: {
                        serverFarmId: appServicePlan.id
                        siteConfig: {
                          alwaysOn: true
                          linuxFxVersion: 'PYTHON|3.11'
                          ftpsState: 'Disabled'
                          appCommandLine: 'startup.sh'
                        }
                        httpsOnly: true
                      }
                      identity: {
                        type: 'SystemAssigned'
                      }
                    
                      resource appSettings 'config' = {
                        name: 'appsettings'
                        properties: {
                          AZURE_POSTGRESQL_HOST: '${postgresServer.name}.postgres.database.azure.com'
                          AZURE_POSTGRESQL_USER: postgresServer.properties.administratorLogin
                          AZURE_POSTGRESQL_PASS: adminPassword
                          AZURE_POSTGRESQL_DBNAME: 'postgres'
                        }
                      }
                    
                      resource webappVnetConfig 'networkConfig' = {
                        name: 'virtualNetwork'
                        properties: {
                          subnetResourceId: virtualNetwork::webappSubnet.id
                        }
                      }
                    }
                    
                    resource appServicePlan 'Microsoft.Web/serverfarms@2021-03-01' = {
                      name: '${name}-service-plan'
                      location: location
                      sku: {
                        name: 'B1'
                      }
                      properties: {
                        reserved: true
                      }
                    }
                    
                    resource postgresServer 'Microsoft.DBforPostgreSQL/flexibleServers@2022-01-20-preview' = {
                      name: pgServerPrefix
                      location: location
                      sku: {
                        name: 'Standard_B1ms'
                        tier: 'Burstable'
                      }
                      properties: {
                        administratorLogin: 'postgresadmin'
                        administratorLoginPassword: adminPassword
                        storage: {
                          storageSizeGB: 128
                        }
                        version: '14'
                        network: {
                          delegatedSubnetResourceId: virtualNetwork::databaseSubnet.id
                          privateDnsZoneArmResourceId: privateDnsZone.id
                        }
                      }
                    }</code></pre>
                <p>👁️ See full example in <a target="_blank" href="vnet.bicep"><code>postgres_vnet.bicep</code></a></p>

            </section>


            <section>
                <h3>All together: PostgreSQL in VNet (Result)</h3>
                <p style="margin-bottom: 0px;">All resources will be listed in the Portal:</p>
                <img src="screenshot_azureportal_vnet.png" screenshot="Screenshot of all resources in Azure Portal: VNet, DNS Zone, PostgreSQL server, App Service" style="border:1px solid #ccc;">
            </section>

            <section class="heading-only">
                <h2>Tips & Tricks</h2>

                <img src="../media/BIT_PUBLIC_SPEAKING.svg" alt="Bit the raccoon as a public speaker" height="300"/>
            </section>
            
            <section>
                <h3>PostgreSQL tips</h3>

                <ul>
                    <li><strong>Managed identity</strong> is a more secure approach
                        than username/password. See sample at:
                        <a target="_blank" href="https://github.com/Azure-Samples/flask-postgresql-managed-identity">
                        github.com/Azure-Samples/flask-postgresql-managed-identity
                        </a>
                    <li><strong>Location, location, location</strong>: <br>
                        There are some location constraints for PostgreSQL servers,
                        especially for Microsoft employees. If you get a funky error,
                        try again with a new location (like "centralus").
                    <li><strong>Many things can't be changed after creation</strong>:
                        admin username, PostgreSQL version, location, networking option, etc.
                        Give everything a good look before you start adding production data.
                </ul>

            </section>

            <section>
                <h3>Bicep linting</h3>

                <p>Use <code>az bicep build</code> command to check file for errors:</p>
                <pre style="font-size:22px;"><code data-trim data-noescape class="shell">
                $ az bicep build -f pg.bicep
                </code></pre>

                <p class="padded">Use a CI/CD workflow to always check for errors:</p>
                <pre><code data-trim data-noescape class="yaml">
                    steps:
                        - name: Checkout
                        uses: actions/checkout@v2
                
                        - name: Azure CLI script
                        uses: azure/CLI@v1
                        with:
                            inlineScript: az bicep build -f infra/main.bicep
                </code></pre>

                <p class="smaller">👁️ See whole file: <a target="_blank" href="https://github.com/pamelafox/flask-charts-api-container-app/blob/main/.github/workflows/azure-bicep-validate.yaml"><code>azure-bicep.yaml</code></a>
                </p>
            </section>
            
            <section>
                <h3>Bicep security validation</h3>

                <p>Use <a target="_blank" href="https://github.com/microsoft/security-devops-action">Microsoft Security DevOps action</a> to find security issues in Bicep files:</p>

                <pre><code data-trim data-noescape class="yaml">
                - name: Run Microsoft Security DevOps Analysis
                    uses: microsoft/security-devops-action@preview
                    id: msdo
                    with:
                    tools: templateanalyzer
                </code></pre>

                <p class="padded">Example output:</p>
                <pre style="white-space:normal"><code data-trim data-noescape class="text">
                Error:      1. TemplateAnalyzer Error AZR-000284 - File: infra/main.bicep. Line: 54. Column 0. 
                Tool: TemplateAnalyzer: Rule: AZR-000284 (Azure.Deployment.AdminUsername).
                https://azure.github.io/PSRule.Rules.Azure/en/rules/Azure.Deployment.AdminUsername/
                Resource properties can be configured using a hardcoded value or Azure Bicep/ template
                expressions. When specifing sensitive values, use secure parameters such as secureString
                or secureObject.
                </code></pre>

                 <p class="smaller">👁️ See whole file: <a target="_blank" href="https://github.com/tonybaloney/django-on-azure/blob/d4f2b63d6e1b9623c2ecd988cda748130f952547/.github/workflows/azure-dev-validate.yml"><code>azure-dev-validate.yaml</code></a>
                 </p>
            </section>

            <section>
                <h3>More Bicep tips</h3>

                <ul>
                    <li>Install the <a target="_blank" href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-bicep">Bicep extension</a> for VS Code
                      <br>
                      <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi0vupCxhnmlq8fw9yee07f60VDJ4Sj5OacTHtuXR_kY35k--sYusG4vJ1bw9FnsaOFi7uQoAJkV79mTB3LhwNHZ36yovxcy16KeNbU81r39A7T1dmM3XaVLVMCSFptEfStbpsEjHd5ibuSsJUawZUSKUtNKAJyG2E6cShGTkVtu0KrO5KCsigrP8w/s1600/Screenshot%202023-01-13%20at%202.59.36%20PM.png" alt="Screenshot of Bicep extension erroring on dead code" style="border: 1px solid #ccc; height: 200px; ">

                    <li>Open the <a target="_blank" href="https://learn.microsoft.com/en-us/azure/templates/">Bicep reference</a> (and keep it open)
                    <li>Search Github for examples using "lang:bicep"
                    <li>Create the resource in Portal and export the template
                </ul>

                <p class="smaller">
                  <a target="_blank" href="https://blog.pamelafox.org/2023/01/tips-for-writing-bicep-files-for-azure.html">
                    <span class="aka"> 🔗 aka.ms/bicep-tips</span>
                    Tips for writing Bicep files
                  </a>
                </p>
            </section>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/reveal.js/dist/reveal.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.5.0/plugin/highlight/highlight.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlightjs-badge@0.1.9/highlightjs-badge.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js-menu@2.1.0/menu.js"></script>
    <script src="terraform.js"></script>
    <script>
        Reveal.initialize({
            width: 1280,
            height: 720,
            hash: true,
            center: false,
            slideNumber: true,
            showNotes: false,
            margin: 0.1,
            preloadIframes: true,
            autoPlayMedia: true,
            plugins: [ RevealHighlight, RevealMenu ],
            highlight: {
                beforeHighlight: hljs => hljs.registerLanguage('bicep', window.hljsDefineBicep)
            },
            pdfSeparateFragments: true
        });
        window.highlightJsBadge();


    </script>
    </body>
</html>